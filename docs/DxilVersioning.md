# DXIL Versioning Reference

This document provides a comprehensive overview of how DXIL (DirectX Intermediate Language) versioning works in the DirectXShaderCompiler, including all the places where version constants are defined and used.

## Table of Contents

1. [Overview](#overview)
2. [Version Constant Definitions](#version-constant-definitions)
3. [Metadata and Container Formats](#metadata-and-container-formats)
4. [Version Generation and Build Process](#version-generation-and-build-process)
5. [Version Checking and Validation](#version-checking-and-validation)
6. [Shader Model to DXIL Version Mapping](#shader-model-to-dxil-version-mapping)
7. [Version Usage in Tools](#version-usage-in-tools)

## Overview

DXIL shaders have three versioning mechanisms:

1. **Shader Model Version** - Describes the target execution model and environment (e.g., `ps_6_5`, `cs_6_0`)
2. **DXIL Version** - Defines the rules for expressing Direct3D shader programs (e.g., `1.5`, `1.8`)
3. **LLVM Bitcode Version** - Currently fixed at LLVM 3.7 for all DXIL versions

The DXIL version for a shader is typically set based on the shader model to ensure that any device supporting that particular shader model will be able to interpret the DXIL properly.

## Version Constant Definitions

### Primary DXIL Version Constants

**File:** `include/dxc/DXIL/DxilConstants.h`

```cpp
// Lines 28-33
namespace DXIL {
  // DXIL version.
  const unsigned kDxilMajor = 1;
  
  // Minor version is auto-generated by hctdb_instrhelp.py during build
  // This shows the current generated value:
  const unsigned kDxilMinor = 10;  // Current: DXIL 1.10
  
  // Helper functions
  inline unsigned MakeDxilVersion(unsigned DxilMajor, unsigned DxilMinor);
  inline unsigned GetCurrentDxilVersion();
  inline unsigned GetDxilVersionMajor(unsigned DxilVersion);
  inline unsigned GetDxilVersionMinor(unsigned DxilVersion);
  inline int CompareVersions(unsigned Major1, unsigned Minor1, 
                             unsigned Major2, unsigned Minor2);
}
```

**Generation:** The `kDxilMinor` constant is auto-generated by:
- Script: `utils/hct/hctdb_instrhelp.py`
- Function: `get_dxil_version_minor()` (line 1735)
- Updates based on: Latest shader model definitions in `hctdb.py`

### Shader Model Version Constants

**File:** `include/dxc/DXIL/DxilShaderModel.h`

```cpp
// Lines 35-45
class ShaderModel {
public:
  // Highest recognized shader model (includes preview/unreleased)
  static const unsigned kHighestMajor = 6;
  static const unsigned kHighestMinor = 10;
  
  // Highest released shader model (public release only)
  static const unsigned kHighestReleasedMajor = 6;
  static const unsigned kHighestReleasedMinor = 9;
  
  // Offline shader model marker
  static const unsigned kOfflineMinor = 0xF;
  
  // Version comparison helpers
  bool IsSMAtLeast(unsigned Major, unsigned Minor) const;
  bool IsSM60Plus() const;  // Returns true for SM 6.0 and above
  bool IsSM61Plus() const;  // Returns true for SM 6.1 and above
  // ... continues through IsSM610Plus()
};
```

**Generation:** These constants are auto-generated by:
- Script: `utils/hct/hctdb_instrhelp.py`
- Functions: `get_highest_shader_model()`, `get_highest_released_shader_model()`

### Container Version Constants

**File:** `include/dxc/DxilContainer/DxilContainer.h`

```cpp
// Lines 28-30
static const uint16_t DxilContainerVersionMajor = 1;
static const uint16_t DxilContainerVersionMinor = 0;
static const uint32_t DxilContainerMaxSize = 0x80000000;

// Container structure
struct DxilContainerVersion {
  uint16_t Major;
  uint16_t Minor;
};

struct DxilContainerHeader {
  uint32_t HeaderFourCC;
  DxilContainerHash Hash;
  DxilContainerVersion Version;  // Container format version
  uint32_t ContainerSizeInBytes;
  uint32_t PartCount;
};

// DXIL program header within container
struct DxilBitcodeHeader {
  uint32_t DxilMagic;      // ASCII "DXIL"
  uint32_t DxilVersion;    // DXIL version (encoded)
  uint32_t BitcodeOffset;  // Offset to LLVM bitcode
  uint32_t BitcodeSize;    // Size of LLVM bitcode
};
```

**Usage:** 
- Container version describes the DXIL container format itself
- DXIL version within the container describes the shader IL version

### Pipeline State Validation (PSV) Version Constants

**File:** `include/dxc/DxilContainer/DxilPipelineStateValidation.h`

```cpp
// Line 477
#define MAX_PSV_VERSION 3
```

**Purpose:** PSV (Pipeline State Validation) version controls the format of the PSV0 container part which contains runtime validation data.

**Version Mapping:** `lib/DxilContainer/DxilPipelineStateValidation.cpp`

```cpp
uint32_t GetPSVVersion(uint32_t ValMajor, uint32_t ValMinor) {
  unsigned PSVVersion = MAX_PSV_VERSION;
  // Constraint PSVVersion based on validator version
  if (DXIL::CompareVersions(ValMajor, ValMinor, 1, 1) < 0)
    PSVVersion = 0;  // Validator < 1.1 uses PSV0
  else if (DXIL::CompareVersions(ValMajor, ValMinor, 1, 6) < 0)
    PSVVersion = 1;  // Validator 1.1-1.5 uses PSV1
  else if (DXIL::CompareVersions(ValMajor, ValMinor, 1, 8) < 0)
    PSVVersion = 2;  // Validator 1.6-1.7 uses PSV2
  return PSVVersion;  // Validator >= 1.8 uses PSV3
}
```

**PSV Version Evolution:**
- **PSV0:** Original format (Validator 1.0)
- **PSV1:** Added resource binding info (Validator 1.1+)
- **PSV2:** Extended signature information (Validator 1.6+)
- **PSV3:** Additional runtime data (Validator 1.8+)

### Compiler Version Constants

**File:** `utils/version/version.inc` (baseline) and generated `dxcversion.inc`

```
// version.inc baseline
1.9.2602.0

// Generated dxcversion.inc contains:
RC_VERSION_FIELD_1  1
RC_VERSION_FIELD_2  9
RC_VERSION_FIELD_3  2602
RC_VERSION_FIELD_4  0
RC_FILE_VERSION "1.9.2602.0"
RC_PRODUCT_VERSION "1.9.2602.0 (main, 47e31c8a)"
```

## Metadata and Container Formats

### DXIL Version Metadata

**Metadata Name:** `dx.version`

**Format:**
```llvm
!dx.version = !{!0}
!0 = !{i32 <major>, i32 <minor>}
```

**Example:**
```llvm
!dx.version = !{!0}
!0 = !{i32 1, i32 8}  ; DXIL 1.8
```

**Code Locations:**
- **Emission:** `lib/DXIL/DxilMetadataHelper.cpp` - `EmitDxilVersion()`
- **Loading:** `lib/DXIL/DxilMetadataHelper.cpp` - `LoadDxilVersion()`
- **Constant:** `lib/DXIL/DxilMetadataHelper.cpp` - `kDxilVersionMDName = "dx.version"`

### Shader Model Metadata

**Metadata Name:** `dx.shaderModel`

**Format:**
```llvm
!dx.shaderModel = !{!0}
!0 = !{!"<shaderKind>", i32 <major>, i32 <minor>}
```

**Example:**
```llvm
!dx.shaderModel = !{!0}
!0 = !{!"ps", i32 6, i32 5}  ; Pixel Shader 6.5
```

**Shader Kind Values:**
- `vs` - Vertex Shader
- `hs` - Hull Shader
- `ds` - Domain Shader
- `gs` - Geometry Shader
- `ps` - Pixel Shader
- `cs` - Compute Shader
- `lib` - Library
- `ms` - Mesh Shader
- `as` - Amplification Shader

**Code Locations:**
- **Emission:** `lib/DXIL/DxilMetadataHelper.cpp` - `EmitDxilShaderModel()`
- **Loading:** `lib/DXIL/DxilMetadataHelper.cpp` - `LoadDxilShaderModel()`

### Validator Version Metadata

**Metadata Name:** `dx.valver`

**Format:**
```llvm
!dx.valver = !{!0}
!0 = !{i32 <major>, i32 <minor>}
```

**Purpose:** Records the minimum validator version required to validate this shader

**Code Locations:**
- **Emission:** `lib/DXIL/DxilMetadataHelper.cpp` - `EmitValidatorVersion()`
- **Loading:** `lib/DXIL/DxilMetadataHelper.cpp` - `LoadValidatorVersion()`

## Version Generation and Build Process

### Build-Time Version Generation

**Script:** `utils/version/gen_version.py`

**Build Types:**

1. **Official Build** (`-official` flag)
   - Format: `major.minor.rev.commit_count`
   - Example: `1.5.1905.42`
   - Uses `utils/version/latest-release.json` as baseline
   - Adds 10,000 to commit count for main branch

2. **Dev Build** (default)
   - Format: `major.minor.0.commit_count`
   - Example: `1.5.0.5234`
   - Uses total commit count since project start

3. **Fixed Version** (`-fv` flag)
   - Reads from `utils/version/version.inc`
   - No git interaction

**Generated Macros:**
```cpp
#define RC_VERSION_FIELD_1 1
#define RC_VERSION_FIELD_2 9  
#define RC_VERSION_FIELD_3 2602
#define RC_VERSION_FIELD_4 0
#define RC_FILE_VERSION "1.9.2602.0"
#define RC_PRODUCT_VERSION "1.9.2602.0 (main, 47e31c8a)"
```

**CMake Integration:**
```cmake
# utils/version/CMakeLists.txt
generate_version_include(hlsl_dxcversion_autogen
    "${HLSL_VERSION_LOCATION}/dxcversion.inc"
    ...)
```

### Database-Driven Generation

**Script:** `utils/hct/hctdb_instrhelp.py`

**Key Functions:**
- `get_dxil_version_minor()` - Returns current DXIL minor version (line 1735)
- `get_highest_shader_model()` - Returns highest shader model version
- `get_is_valid_for_dxil()` - Generates valid shader model version checks
- `get_min_validator_version()` - Generates validator version requirements

**Data Source:** `utils/hct/hctdb.py` - Central database of all DXIL operations, shader models, and features

**Code Generation Markers:**
Files contain Python code generation markers:
```cpp
/* <py::lines('VALRULE-TEXT')>hctdb_instrhelp.get_dxil_version_minor()</py>*/
// VALRULE-TEXT:BEGIN
const unsigned kDxilMinor = 10;
// VALRULE-TEXT:END
```

## Version Checking and Validation

### Compilation Version Checking

**File:** `lib/DxcSupport/HLSLOptions.cpp`

```cpp
// Lines 1016-1021
// Check if requested DXIL version is supported
if (major64 > DXIL::kDxilMajor ||
    (major64 == DXIL::kDxilMajor && minor64 > DXIL::kDxilMinor)) {
  errors << "DXIL version " << major64 << "." << minor64 
         << " is not supported. Maximum supported version: "
         << DXIL::kDxilMajor << "." << DXIL::kDxilMinor;
  return false;
}
```

### Validation Version Checking

**File:** `lib/DxilValidation/DxilValidation.cpp`

```cpp
// Lines 3989-4011
// Validate DXIL version metadata
NamedMDNode *pNode = pModule->getNamedMetadata("dx.version");
if (!pNode) {
  EmitError("Missing dx.version metadata");
  return false;
}

// Check version is within supported range
if ((MajorVer == DXIL::kDxilMajor && MinorVer <= DXIL::kDxilMinor) &&
    (!ValCtx.M.GetValidatorVersion() || 
     ValCtx.M.GetValidatorVersion().NotSupportDxilVersion(MajorVer, MinorVer))) {
  ValCtx.EmitFormatError(
      ValidationRule::MetaVersionSupported,
      {"DXIL Version", std::to_string(MajorVer), std::to_string(MinorVer)});
}
```

### Runtime Version Queries

**File:** `tools/clang/tools/dxcompiler/dxcompilerobj.cpp`

```cpp
// Lines 1693-1694
// IDxcVersionInfo::GetVersion implementation
*pMajor = DXIL::kDxilMajor;
*pMinor = DXIL::kDxilMinor;
```

## Shader Model to DXIL Version Mapping

**File:** `lib/DXIL/DxilShaderModel.cpp`

```cpp
// Lines 300-346
void ShaderModel::GetDxilVersion(unsigned &DxilMajor, unsigned &DxilMinor) const {
  DxilMajor = 1;
  switch (m_Minor) {  // Shader model minor version
  case 0:
  case 1:
  case 2:
    DxilMinor = m_Minor;  // SM 6.0 -> DXIL 1.0, SM 6.1 -> DXIL 1.1, etc.
    break;
  case 3:
    DxilMinor = 3;  // SM 6.3 -> DXIL 1.3
    break;
  case 4:
    DxilMinor = 4;  // SM 6.4 -> DXIL 1.4
    break;
  case 5:
    DxilMinor = 5;  // SM 6.5 -> DXIL 1.5
    break;
  case 6:
    DxilMinor = 6;  // SM 6.6 -> DXIL 1.6
    break;
  case 7:
    DxilMinor = 7;  // SM 6.7 -> DXIL 1.7
    break;
  case 8:
    DxilMinor = 8;  // SM 6.8 -> DXIL 1.8
    break;
  case 9:
    DxilMinor = 9;  // SM 6.9 -> DXIL 1.9
    break;
  case 10:
    DxilMinor = 10;  // SM 6.10 -> DXIL 1.10
    break;
  case kOfflineMinor:  // Offline shader model uses latest DXIL
    DxilMinor = DXIL::kDxilMinor;
    break;
  }
}
```

### Minimum Validator Version Requirements

**File:** `lib/DXIL/DxilShaderModel.cpp`

```cpp
// Lines 354-407
void ShaderModel::GetMinValidatorVersion(unsigned &ValMajor, unsigned &ValMinor) const {
  ValMajor = 1;
  switch (m_Minor) {  // Shader model minor version
  case 0: ValMinor = 0; break;  // SM 6.0 requires Validator 1.0
  case 1: ValMinor = 1; break;  // SM 6.1 requires Validator 1.1
  case 2: ValMinor = 2; break;  // SM 6.2 requires Validator 1.2
  // ... pattern continues ...
  case 9: ValMinor = 9; break;  // SM 6.9 requires Validator 1.9
  case 10: ValMinor = 10; break;  // SM 6.10 requires Validator 1.10
  }
}
```

**Key Relationship:** The validator version typically matches the DXIL version which matches the shader model minor version.

## Version Usage in Tools

### DXC Compiler

**File:** `tools/clang/tools/dxclib/dxc.cpp`

**Version Options:**
- `-T <profile>` - Sets shader model (e.g., `ps_6_5`, `cs_6_0`)
  - Implicitly sets DXIL version based on shader model
- Version info available via `IDxcVersionInfo` interface

### Validator

**File:** `tools/clang/tools/dxcvalidator/dxcvalidator.cpp`

**Validation Checks:**
1. DXIL version metadata present and valid
2. DXIL version compatible with shader model
3. DXIL version not newer than validator supports
4. Features used are supported by declared DXIL version

### Container Assembler

**File:** `lib/DxilContainer/DxilContainerAssembler.cpp`

**Version Handling:**
- Reads DXIL version from module metadata
- Encodes version in `DxilBitcodeHeader`
- Sets container version in `DxilContainerHeader`

### Container Reader

**File:** `lib/DxilContainer/DxilContainerReader.cpp`

**Version Parsing:**
- Extracts DXIL version from bitcode header
- Validates container version
- Checks compatibility with current tools

## Version History and Evolution

### DXIL Version Timeline

| DXIL Version | Shader Model | Major Features | Release |
|--------------|--------------|----------------|---------|
| 1.0 | 6.0 | Initial DXIL release | 2016 |
| 1.1 | 6.1 | ViewInstancing, Barycentrics | 2017 |
| 1.2 | 6.2 | 16-bit types, Native low precision | 2018 |
| 1.3 | 6.3 | DXR (Raytracing), Library shaders | 2018 |
| 1.4 | 6.4 | VRS (Variable Rate Shading) | 2019 |
| 1.5 | 6.5 | DXR 1.1, Sampler Feedback, Mesh Shaders | 2020 |
| 1.6 | 6.6 | Atomic 64-bit, Descriptor Heap Indexing | 2021 |
| 1.7 | 6.7 | Advanced Texture Ops, Writable MSAA | 2022 |
| 1.8 | 6.8 | Sample Cmp Gradient/Bias, Extended Command Info | 2023 |
| 1.9 | 6.9 | SER (Shader Execution Reordering), Work Graphs (Preview) | 2024 |
| 1.10 | 6.10 | TBD (Preview) | TBD |

### Backward Compatibility

- DXIL maintains backward compatibility - newer validators can validate older DXIL versions
- Shader models are forward-declared but locked to specific DXIL versions
- Features are gated by both shader model AND DXIL version checks

## Reference Files

### Key Source Files

1. **Version Constants:**
   - `include/dxc/DXIL/DxilConstants.h` - Primary DXIL version constants
   - `include/dxc/DXIL/DxilShaderModel.h` - Shader model version constants
   - `include/dxc/DxilContainer/DxilContainer.h` - Container version constants
   - `include/dxc/DxilContainer/DxilPipelineStateValidation.h` - PSV version constants

2. **Metadata Handling:**
   - `lib/DXIL/DxilMetadataHelper.cpp` - Metadata emission and loading
   - `include/dxc/DXIL/DxilMetadataHelper.h` - Metadata helper interface

3. **Version Logic:**
   - `lib/DXIL/DxilShaderModel.cpp` - Shader model to DXIL version mapping
   - `lib/DXIL/DxilModule.cpp` - Module version management
   - `lib/DxilValidation/DxilValidation.cpp` - Version validation logic
   - `lib/DxilContainer/DxilPipelineStateValidation.cpp` - PSV version logic

4. **Build System:**
   - `utils/version/gen_version.py` - Version generation script
   - `utils/hct/hctdb_instrhelp.py` - Database-driven code generation
   - `utils/hct/hctdb.py` - Central operation/feature database
   - `utils/version/CMakeLists.txt` - Version build integration

5. **Tools:**
   - `tools/clang/tools/dxclib/dxc.cpp` - Compiler tool
   - `tools/clang/tools/dxcvalidator/dxcvalidator.cpp` - Validator tool
   - `tools/clang/tools/dxcompiler/dxcompilerobj.cpp` - Compiler API implementation

### Documentation

- `docs/DXIL.rst` - Official DXIL specification
- `docs/ReleaseNotes.md` - Version release notes
- `README.md` - Project overview

## Summary

DXIL versioning is a multi-layered system:

1. **DXIL Version (1.x)** - The core intermediate language version, defined in `DxilConstants.h`
2. **Shader Model (6.x)** - The programming model version, mapped to DXIL versions
3. **Container Version (1.0)** - The binary container format version
4. **PSV Version (0-3)** - The pipeline state validation data format version
5. **Compiler Version (1.9.xxxx.x)** - The tool version, generated from git history
6. **Validator Version (1.x)** - The minimum validator version required

These versions work together to ensure compatibility across the entire shader compilation and execution pipeline, from source code to hardware execution. The DXIL version typically matches the shader model minor version (e.g., SM 6.5 uses DXIL 1.5), the validator version matches the DXIL version, and the PSV version is derived from the validator version requirements.
